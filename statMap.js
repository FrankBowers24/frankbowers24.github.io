var d3,LabeledPie,topojson,annyang,window,incomePie=new LabeledPie(".tip-info"),statLabels={main:["Income","Race/Ethnicity"],race:["All","Latino","White","African American","Native American","Asian","Pacific Islander","Other Race","Mixed Race"],asian:["All","Asian Indian","Bangladeshi","Cambodian","Mainland Chinese","Filipino","Hmong","Japanese","Korean","Laotian","Pakistani","Taiwanese","Thai","Vietnamese"],birth:["All","California","USA, not California","Foreign"],foreign:["All","Europe","Asia","Africa","Oceania","Latin America","Canada"],age:["All","Under 18","18 to 24","25 to 34","35 to 44","45 to 64","65 and over"]},pieLabelConfig={income:{labels:["< $25K","$25K - $50K","$50K - $75K","$75K - $100K","$100K - $200K","> $200K"],domain:[0,1,2,3,4,5],range:["#a50026","#f46d43","#fee08b","#d9ef8b","#66bd63","#006837"]},race:{labels:statLabels.race.slice(1),domain:[0,1,2,3,4,5,6,7],range:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"]},asian:{labels:statLabels.asian.slice(1),domain:[0,1,2,3,4,5,6,7,8,9,10,11,12],range:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928","#cccccc"]},birth:{labels:statLabels.birth.slice(1),domain:[0,1,2],range:["#1b9e77","#d95f02","#7570b3"]},foreign:{labels:statLabels.foreign.slice(1),domain:[1,2,3,4,5,6],range:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d"]},age:{labels:statLabels.age.slice(1),domain:[0,1,2,3,4,5],range:["#a50026","#f46d43","#fee08b","#d9ef8b","#66bd63","#006837"]}},setPieLabels=function(e,t){d3.select(".tip-info").select("svg").remove(),incomePie=new LabeledPie(".tip-info");var a=d3.scale.ordinal().domain(e[t].domain).range(e[t].range);incomePie.setLabels(e[t].labels),incomePie.setColorScale(a)},setLegendDescription=function(e,t){var a={income:"Percentage of income tax returns with AGI greater than $200,000",race:"Percentage of # race/ethnicity",asian:"Percentage of Asians listed as #",birth:"Percentage of # Born",foreign:"Percentage of Foreign Born from #",age:"Percentage of population age #"},n={income:"AGI reported on 2012 income tax return",race:"Race/Ethnicity",asian:"National origin of Asians",birth:"Place of birth",foreign:"Regional origin of Foreign Born Population",age:"Age"},i=a[e];i.indexOf("#")>=0&&(i=i.replace("#",statLabels[e][t])),d3.select(".legend-description").text(i),d3.select(".tip-description").text(n[e])},createComboBoxes=function(){var e=statLabels.race.slice(1),t=d3.select("#race-list").selectAll("option").data(e);t.enter().append("option").attr("value",function(e,t){return t+1}).text(function(e){return e});var a=d3.select("#asian-list").selectAll("option").data(statLabels.asian);a.enter().append("option").attr("value",function(e,t){return t}).text(function(e){return e});var n=d3.select("#birth-list").selectAll("option").data(statLabels.birth.slice(1));n.enter().append("option").attr("value",function(e,t){return t+1}).text(function(e){return e});var i=d3.select("#foreign-list").selectAll("option").data(statLabels.foreign);i.enter().append("option").attr("value",function(e,t){return t}).text(function(e){return e});var o=d3.select("#age-list").selectAll("option").data(statLabels.age.slice(1));o.enter().append("option").attr("value",function(e,t){return t+1}).text(function(e){return e})};createComboBoxes();var createLegend=function(e,t,a){var n={percent:d3.format("%"),percentPointOne:d3.format("2.1%")};d3.select("#legend ul").remove();var i=d3.select("#legend").append("ul").attr("class","list-inline"),o=i.selectAll("li.key").data(e.range()),s=e.range()[e.range().length-1],l=e.invertExtent(s),c=l[0]<.1;o.enter().append("li").attr("class","key").style("border-top-color",String).text(function(t){var a=e.invertExtent(t);return c?n.percentPointOne(a[0]):n.percent(a[0])}),setLegendDescription(t,a)},zipCodeMap=function(e,t){function a(e,t){var a=e.properties.GEOID10,n=t[a][S];return n?+n[L]/+n[0]:null}function n(e){return e.properties.GEOID10+": "+e.properties.city}function i(e,t,a){a=a||t[e.properties.GEOID10][S];var n=a.slice(1);+a[0]>0?(d3.select(".tip-info").classed("hidden",!1),d3.select(".tip-description").classed("hidden",!1),incomePie.change(n)):(d3.select(".tip-info").classed("hidden",!0),d3.select(".tip-description").classed("hidden",!1))}function o(e){var t=topojson.feature(e,e.objects.Bay_Area),a=t.features.filter(function(e){return"94560"===e.properties.GEOID10})[0];s(a)}function s(e,t){var a=h.centroid(e),n=v.translate();v.translate([n[0]-a[0]+f/2,n[1]-a[1]+u/2]),m.translate(v.translate()),t?y.selectAll("path").transition().duration(1e3).attr("d",h):y.selectAll("path").attr("d",h)}function l(){}function c(){v.translate(d3.event.translate).scale(d3.event.scale),y.selectAll("path").attr("d",h)}function r(){var e=(d3.select(".selected"),d3.select(".selected").datum()),t=h.bounds(e),a=(t[1][0]-t[0][0],t[1][1]-t[0][1],(t[0][0]+t[1][0])/2),n=(t[0][1]+t[1][1])/2,i=b,o=[f/2-i*a,u/2-i*n];y.transition().duration(750).call(m.translate(o).scale(i).event)}var d,p,f=650,u=1e3,g=39321.6,b=91750.4,v=d3.geo.albersUsa().scale(39321.6).translate([f/2,u/2]),h=d3.geo.path().projection(v),m=d3.behavior.zoom().translate(v.translate()).scale(v.scale()).scaleExtent([g,b]).on("zoom",c),C=d3.scale.quantize().range(["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"]),y=d3.select(".right-side").append("svg").attr("width",f).attr("height",u).call(m),L=6,S="income",A=function(){var e,t={},a=topojson.feature(p,p.objects.Bay_Area);return a.features.forEach(function(a){for(e in a.properties)t[a.properties[e]]=!0}),Object.keys(t)},z=function(e){S=e},M=function(e){L=e},P=function(){var t=topojson.feature(p,p.objects.Bay_Area);C.domain(d3.extent(t.features,function(e){return a(e,d)})),e(C,S,L)},x=function(e){var t=a(e,d);return t?C(t):"#ccc"},D=function(){P(),y.selectAll("path").transition().duration(1e3).attr("fill",function(e){return x(e)})},B=function(e,t){var a,o,l,c,r=[],f=[],u=topojson.feature(p,p.objects.Bay_Area);u.features.forEach(function(a){a.properties[e]===t&&r.push(a)}),r.length>0&&(d3.selectAll(".selected").classed("selected",!1),r.forEach(function(e){for(o=e.properties.GEOID10,l=d[o][S],c=0;c<l.length;c++)f[c]=f[c]||0,f[c]+=+l[c]}),a=r.length>1?t:n(r[0]),d3.select(".tip-location").text(a),i(null,d,f)),y.selectAll("path")[0].forEach(function(a){a=d3.select(a),a.datum().properties[e]===t&&a.classed("selected",!0)}),r.length>0&&(f=r[0],s(f,!0))};return d3.json("data/allStats.json",function(e){d=e,d3.json("Bay_Area_Cities_topo.json",function(e){p=e;var t=[];P(),y.selectAll("path").data(topojson.feature(e,e.objects.Bay_Area).features).enter().append("path").attr("d",h).attr("stroke","black").attr("fill",function(e){return x(e)}).on("click",function(e){d3.selectAll(".selected").classed("selected",!1),d3.select(this).classed("selected",!0),d3.select(".tip-location").text(n(e)),i(e,d),t=[d3.event.x,d3.event.y]}).on("mousemove",l).append("svg:title").text(function(e){return n(e)}),o(e),d3.select(".right-side").on("click",function(){d3.event.x!==t[0]&&d3.event.y!==t[1]&&(d3.selectAll(".selected").classed("selected",!1),d3.select(".tip-info").classed("hidden",!0),d3.select(".tip-description").classed("hidden",!0),d3.select(".tip-location").text("")),t=[]})})}),t(pieLabelConfig,"income"),{getPropertyValues:A,setStatType:z,setStatIndex:M,updateStats:D,selectByData:B,zoomOut:r}}(createLegend,setPieLabels),getSelectionTitle=function(){var e=d3.select(".tip-location").text().split(":")[0];return e},selectByData=function(e){var t=e.match(/[0-9]/)?"GEOID10":"city";zipCodeMap.selectByData(t,e)};d3.select("#zoom-out").on("click",function(){window.event.stopPropagation(),zipCodeMap.zoomOut()});var gotoVoiceCommand=function(e){$("#select-input").val(e),selectByData(e)},showMeVoiceCommand=function(e){var t=0;"income"===e?t=0:"race"===e&&(t=1),$("#stat-list").val(t),$("#stat-list").trigger("change")},enableVoiceCommands=function(){var e={"go to *place":gotoVoiceCommand,"show me *stat":showMeVoiceCommand};annyang&&(console.log(annyang),annyang.start(),annyang.debug(),annyang.addCommands(e))};$("#stat-list").on("change",function(){var e=+d3.select("#stat-list").node().value,t=+d3.select("#race-list").node().value,a=+d3.select("#birth-list").node().value,n=(+d3.select("#foreign-list").node().value,+d3.select("#age-list").node().value);d3.select("#race-list").classed("hidden",1!==e),d3.select("#asian-list").classed("hidden",1!==e||5!==t),d3.select("#birth-list").classed("hidden",2!==e),d3.select("#foreign-list").classed("hidden",2!==e||3!==a),d3.select("#age-list").classed("hidden",3!==e),0===e?(zipCodeMap.setStatType("income"),zipCodeMap.setStatIndex(6),setPieLabels(pieLabelConfig,"income"),selectByData(getSelectionTitle())):1===e?5===t?selectAsian():(zipCodeMap.setStatType("race"),zipCodeMap.setStatIndex(t),setPieLabels(pieLabelConfig,"race"),selectByData(getSelectionTitle())):2===e?3===a?selectForeign():(zipCodeMap.setStatType("birth"),zipCodeMap.setStatIndex(a),setPieLabels(pieLabelConfig,"birth"),selectByData(getSelectionTitle())):3===e&&(zipCodeMap.setStatType("age"),zipCodeMap.setStatIndex(n),setPieLabels(pieLabelConfig,"age"),selectByData(getSelectionTitle())),zipCodeMap.updateStats()}),d3.select("#race-list").on("change",function(){var e=+d3.select("#race-list").node().value;d3.select("#asian-list").classed("hidden",5!==e),5===e?selectAsian():(zipCodeMap.setStatType("race"),zipCodeMap.setStatIndex(e),setPieLabels(pieLabelConfig,"race"),selectByData(getSelectionTitle())),zipCodeMap.updateStats()});var selectAsian=function(){var e=+d3.select("#asian-list").node().value;0===e?(zipCodeMap.setStatType("race"),zipCodeMap.setStatIndex(5),setPieLabels(pieLabelConfig,"race"),selectByData(getSelectionTitle())):(zipCodeMap.setStatType("asian"),zipCodeMap.setStatIndex(e),setPieLabels(pieLabelConfig,"asian"),selectByData(getSelectionTitle()))};d3.select("#asian-list").on("change",function(){selectAsian(),zipCodeMap.updateStats()});var selectForeign=function(){var e=+d3.select("#foreign-list").node().value;0===e?(zipCodeMap.setStatType("birth"),zipCodeMap.setStatIndex(3),setPieLabels(pieLabelConfig,"birth"),selectByData(getSelectionTitle())):(zipCodeMap.setStatType("foreign"),zipCodeMap.setStatIndex(e),setPieLabels(pieLabelConfig,"foreign"),selectByData(getSelectionTitle()))};d3.select("#foreign-list").on("change",function(){selectForeign(),zipCodeMap.updateStats()}),d3.select("#birth-list").on("change",function(){var e=+d3.select("#birth-list").node().value;d3.select("#foreign-list").classed("hidden",3!==e),3===e?selectForeign():(zipCodeMap.setStatType("birth"),zipCodeMap.setStatIndex(e),setPieLabels(pieLabelConfig,"birth"),selectByData(getSelectionTitle())),zipCodeMap.updateStats()}),d3.select("#age-list").on("change",function(){var e=+d3.select("#age-list").node().value;zipCodeMap.setStatType("age"),zipCodeMap.setStatIndex(e),setPieLabels(pieLabelConfig,"age"),selectByData(getSelectionTitle()),zipCodeMap.updateStats()}),d3.select("#select-button").on("click",function(){window.event.stopPropagation();var e=d3.select("#select-input").node().value,t=e.match(/[0-9]/)?"GEOID10":"city";zipCodeMap.selectByData(t,e)}),$("#select-input").on("propertychange",function(){window.event.stopPropagation(),window.event.preventDefault();var e=d3.select("#select-input").node().value,t=e.match(/[0-9]/)?"GEOID10":"city";return zipCodeMap.selectByData(t,e),!1}),$("#select-input").bind("input propertychange",function(e){e.stopPropagation(),window.event.preventDefault();var t=d3.select("#select-input").node().value,a=t.match(/[0-9]/)?"GEOID10":"city";return zipCodeMap.selectByData(a,t),!1}),$("#select-input").on("val.changed",function(e){e.stopPropagation();var t=d3.select("#select-input").node().value,a=t.match(/[0-9]/)?"GEOID10":"city";zipCodeMap.selectByData(a,t)}),$(document).ready(function(){$(window).keydown(function(e){return 13==e.keyCode?(e.preventDefault(),!1):void 0})}),$("#select-input").autoComplete({minChars:1,source:function(e,t){e=e.toLowerCase();var a,n=zipCodeMap.getPropertyValues(),i=[];for(a=0;a<n.length;a++)~n[a].toLowerCase().indexOf(e)&&i.push(n[a]);t(i)}});